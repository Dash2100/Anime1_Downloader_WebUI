<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- style.css -->
    <link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <link href="{{ url_for('static',filename='fontawesome/fontawesome.css') }}" rel="stylesheet">
    <link href="{{ url_for('static',filename='fontawesome/brands.css') }}" rel="stylesheet">
    <link href="{{ url_for('static',filename='fontawesome/solid.css') }}" rel="stylesheet">
    <title>Anime1 Downloader</title>
</head>

<body onload="getData();">
    <div class="center">
        <div class="title">
            <h3 class="bigtitle">Anime1 Dowloader</h3>
            <i class="history fa-solid fa-clock-rotate-left fa-2x" onclick="window.location.href='./history'"></i>
        </div>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="input" placeholder="URL" aria-describedby="button-addon2">
            <button class="btn btn-primary" type="button" id="button-addon2" onclick="download();">Download</button>
        </div>
        <div id="loader">
            <span class="loader"></span>
        </div>
        <ol class="nowdownload list-group list-group-numbered">

        </ol>
        <hr class="style-one" />
        <div id="loader-waiting">
            <span class="loader"></span>
        </div>
        <ol class="waitdownload list-group list-group-numbered">
        </ol>
    </div>
</body>
<script>
    function download() {

        $.ajax({
            url: "/getData",
            method: "get",
            success: function (res) {
                if (res["status"] === false) {
                    $('#loader').show();
                    console.log("show loader");
                }
                else {
                    $('#loader-waiting').show();
                    console.log("show loader-waiting");
                }
            },
            error: function (res) {
                toast("error", "Something went wrong");
            }
        }).then(function (res) {
            var datas = {
                "url": $("input").val()
            }
            document.getElementById("input").value = "";
            $.ajax({
                url: "/form",
                method: "post",
                data: datas,
                success: function (res) {
                    if (res == "URL Error") {
                        toast('error', "URL Error")
                        $('#loader').hide();
                        $('#loader-waiting').hide();
                    }
                    if (res == "added to queue list") {
                        toast('success', "Added to queue")
                        $('#loader').hide();
                        $('#loader-waiting').hide();
                    }
                    if (res == "already in downloading") {
                        toast('error', "Already in downloading")
                        $('#loader').hide();
                        $('#loader-waiting').hide();
                    }
                    if (res == "Download Complete") {
                        toast('success', "Download Complete")
                    }
                    if (res == "already in queue") {
                        toast('error', "Already in queue")
                        $('#loader').hide();
                        $('#loader-waiting').hide();
                    }
                    if (res == "File Exist") {
                        toast('error', "File is already exist")
                        $('#loader').hide();
                        $('#loader-waiting').hide();
                    }
                },
                error: function (res) {
                    Swal.fire({
                        icon: 'error',
                        title: "Server Error",
                        text: "Please try again later",
                        allowEscapeKey: false,
                        allowOutsideClick: false,
                        showCancelButton: false
                    }).then(function (result) {
                        if (result.value) {
                            window.location.reload();
                        }
                    });
                    $('#loader').hide();
                }
            })
        });
    }

    function stop() {
        Swal.fire({
            title: 'Delete this task?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "/stop",
                    method: "get",
                })
                toast('info', "Next task will run after download complete")
            }
        })
    }

    function rmqueue(name){
        Swal.fire({
            title: 'Delete this task?',
            text: name+" will not be downloaded",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "/rmqueue/"+name,
                    method: "get",
                    success: function (res) {
                        if (res == "OK") {
                            toast('success', "Deleted!")
                        }
                        if (res == "Not Found") {
                            toast('error', "Not Found")
                        }
                    },
                    error: function (res) {
                        toast("error", "Something went wrong");
                    }
                })
                toast('info', "Next task will run after download complete")
            }
        })
    }

    function getData() {
        $.ajax({
            url: "/getData",
            method: "get",
            success: function (res) {
                if (Object.keys(res["downloading"])[0] != undefined) {
                    if (res["status"] === true) {
                        $('#loader').hide();
                        var list = document.getElementsByClassName("nowdownload")[0];
                        list.innerHTML = '<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto"><div class="fw-bold">' + Object.keys(res["downloading"])[0] + '</div>' + Object.values(res["downloading"])[0] + '</div><i onclick="stop();" class="fa-solid fa-trash"></i></li>';
                    }
                }
                if (res["waiting"] != "") {
                    $('#loader-waiting').hide();
                    var list = document.getElementsByClassName("waitdownload")[0];
                    list.innerHTML = String(Object.keys(res["waiting"])).split(",").map((item) => {
                        name = Object.keys(res["waiting"][item]);
                        strname = "'" + name + "'";
                        return '<li class="list-group-item d-flex justify-content-between align-items-start"><div class="ms-2 me-auto"><div class="fw-bold">' + name + '</div> </div><i onclick="rmqueue(' + strname + ');" class="fa-solid fa-trash"></i></li>';
                    }).join("");
                }
                else {
                    var list = document.getElementsByClassName("waitdownload")[0];
                    list.innerHTML = '';
                }
                if (res["status"] === true) {
                    if (Object.keys(res["downloading"])[0] === undefined) {
                        $('#loader').show();
                        var list = document.getElementsByClassName("nowdownload")[0];
                        list.innerHTML = '';
                    }
                }
                if (res["status"] === false) {
                    var list = document.getElementsByClassName("nowdownload")[0];
                    list.innerHTML = '';
                    $('#loader').hide();
                    $('#loader-waiting').hide();
                }
            },
            error: function (res) {
                console.log("API error");
            }
        })
    }

    function toast(type, text) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'bottom-right',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        })

        Toast.fire({
            icon: type,
            title: text
        })
    }

    var intervalID = window.setInterval(getData, 1500);
</script>

</html>